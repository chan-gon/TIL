# 스트림과 병렬 처리

자바 7 이전까지 List<String>\ 컬렉션에서 요소를 순차적으로 처리하기 위해 Iterator 반복자를 다음과 같이 사용했다.

<pre>
<code>
List<String> list = Arrays.asList("A", "B", "C");
Iterator<String> iterator = list.iterator();
while(iterator.hasNext()){
    String str = iterator.next();
    System.out.println(str);
}
</code>
</pre>

위 코드를 Stream을 사용해서 변경하면 다음과 같다.

<pre>
<code>
List<String> list = Arrays.asList("A", "B", "C");
Stream<String> stream = list.stream();
stream.forEach(name->System.out.println(name));
</code>
</pre>

컬렉션(java.util.Collection)의 stream() 메소드로 스트림 객체를 얻고 나서 stream.forEach(name->System.out.printnln(name)); 메소드를 통해 컬렉션의 요소를 하나씩 콘솔에 출력한다. forEach() 메소드는 Consumer 함수적 인터페이스 타입의 매개값을 가지므로 컬렉션의 요소를 소비할 코드를 람다식으로 기술할 수 있따.

<pre>
<code>
void forEach(Consumer<T> action)
</code>
</pre>

아래 코드는 List<String> 컬렉션의 String 요소를 Iterator와 Stream을 이용해서 순차적으로 콘솔에 출력한다.

<pre>
<code>
import java.util.Arrays;
import java.util.Iterator;
import java.util.List;
import java.util.stream.Stream;

public class Main {
    public static void main(String[] args) {
        List<String> list = Arrays.asList("A", "B", "C");

        // iterator
        Iterator<String> iterator = list.iterator();
        while(iterator.hasNext()){
            String str = iterator.next();
            System.out.println(str);
        }

        // Stream
        Stream<String> stream = list.stream();
        stream.forEach(name->System.out.println(name));
    }
}
</code>
</pre>

### Stream의 특징

Stream은 Iterator와 비슷하지만 람다식으로 요소 처리 코드를 제공하는 점과 내부 반복자를 사용하므로 병렬 처리가 쉽다는 것, 중간 처리와 최종 처리 작업을 수행하는 점에서 많은 차이가 있다. 

### Stream의 특징_람다식으로 요소 처리 코드 제공

Stream이 제공하는 대부분의 요소 처리 메소드는 함수적 인터페이스 매개 타입을 가지기 때문에 람다식 또는 메소드 참조를 이용해서 요소 처리 내용을 매개값으로 전달할 수 있다. 

아래 코드는 컬렉션에 저장된 Student를 하나씩 가져와 학생 이름과 성적을 콘솔에 출력하도록 forEach() 메소드의 매개값으로 람다식을 주었다.

<pre>
<code>
import java.util.Arrays;
import java.util.List;
import java.util.stream.Stream;

public class Main {
    public static void main(String[] args) {
        List<Student> list = Arrays.asList(
            new Student("Park", 98),
            new Student("Hong", 78)
        );

        Stream<Student> stream = list.stream();
        stream.forEach(s->{
            String name = s.getName();
            int score = s.getScore();
            System.o0ut.println(name + " / " + score);
        });
    }
}

public class Student {
    private String name;
    private int score;

    public Student(String name, int score){
        this.name = name;
        this.score = score;

        public String getName() { return name; }
        public int getScore() { return score; }
    }
}
</code>
</pre>

### Stream의 특징_내부 반복자를 사용하므로 병렬 처리가 쉽다.

외부 반복자(external iterator)란 개발자가 코드로 직접 컬렉션의 요소를 반복해서 가져오는 코드 패턴을 말한다. index를 이용하는 for문, Iterator를 이용하는 while문은 모두 외부 반복자를 이용하는 것이다. 

내부 반복자(internal iterator)는 컬렉션 내부에서 요소들을 반복시키고 개발자는 요소당 처리해야 할 코드만 제공하는 코드 패턴을 말한다. 

내부 반복자 사용 시 컬렉션 내부에서 어떻게 요소를 반복시킬 것인가는 컬렉션에게 맡겨두고 개발자는 요소 처리 코드에만 집중할 수 있다. 내부 반복자는 요소들의 반복 순서를 변경하거나 멀티 코어 CPU를 최대한 활용하기 위해 요소들을 분배시켜 병렬 작업을 할 수 있게 도와주기 때문에 하나씩 처리하는 순차적 외부 반복자보다는 효율적으로 요소를 반복시킬 수 있다.

Iterator는 컬렉션의 요소를 가져오는 것에서부터 처리하는 것까지 모두 개발자가 작성해야 한다. 반면 Stream은 람다식으로 요소 처리 내용만 전달할 뿐 반복은 컬렉션 내부에서 일어난다. Stream을 이용하면 코드도 간결해지고, 무엇보다도 요소의 병렬 처리가 컬렉션 내부에서 처리되므로 일석이조의 효과를 가져온다.

### 병렬(parallel) 처리란?

한 가지 작업을 서브 작업으로 나누고, 서브 작업들을 분리된 스레드에서 병렬적으로 처리하는 것을 말한다. 병렬 처리 스트림을 이용하면 런타임 시 하나의 작업을 서브 작업으로 자동으로 나누고, 서브 작업의 결과를 자동으로 결합하여 최종 결과물을 생성한다. 예를 들어 컬렉션의 요소 총합을 구할 때 순차 처리 스트림은 하나의 스레드가 요소들을 순차적으로 읽어 합을 구하지만, 병렬 처리 스트림은 여러 개의 스레드가 요소들을 부분적으로 합하고 이 부분의 합을 최종 결합해서 전체 합을 생성한다. 

<pre>
<code>
import java.util.Arrays;
import java.util.List;
import java.util.stream.Stream;

public class Main {
    public static void main(String[] args) {
        List<String> list = Arrays.asList(
            "Park", "Hong", "Kim", "Hwang"
        );

        // 순차 처리
        Stream<String> stream = list.stream();
        stream.forEach(Main :: print); // == s->Main.print(s)
        System.out.println();

        // 병렬 처리
        Stream<String> parallelStream = list.parallelStream();
        parallelStream.forEach(Main :: print);
    }

    public static void print(String str){
        System.out.println(str + " / " + Thread.currentThread().getName());
    }
}

결과)
Park / main
Hong / main
Kim / main
Hwang / main

Kim / main
Hwang / main
Park / main
Hong / ForkJoinPool.commonPool-worker-1
</code>
</pre>

위 코드의 결과를 보면 병렬 처리 스트림은 main 스레드를 포함해서 ForkJoinPool(스레드풀)의 작업 스레드들이 병렬적으로 요소를 처리하는 것을 볼 수 있다.

### Stream의 특징_스트림은 중간 처리와 최종 처리를 할 수 있다.

Stream은 컬렉션의 요소에 대해 중간 처리와 최종 처리를 수행할 수 있다. 중간 처리에는 매핑, 필터링, 정렬을 수행하고 최종 처리에는 반복, 카운팅, 평균, 총합 등의 집계 처리를 수행한다.

아래 코드는 List에 저장된 Student 객체를 중간 처리에서 score 필드값으로 매핑한다. 이후 최종 처리에서 score의 평균값을 산출한다.

<pre>
<code>
public class Main {
    public static void main(String[] args) {
        List<Student> studentList = Arrays.asList(
            new Student("Park", 78);
            new Student("Hong", 89);
        );

        double avg = studentList.stream()
        // 중간 처리(학생 객체를 점수로 매핑)
        .mapToInt(Student :: getScore)
        // 최종 처리(평균 점수)
        .average()
        .getAsDouble();

        System.out.println("avg score = " + avg);
    }
}
</code>
</pre>

# 출처
* [이것이 자바다](http://www.kyobobook.co.kr/product/detailViewKor.laf?ejkGb=KOR&mallGb=KOR&barcode=9788968481475&orderClick=LAG&Kc=)